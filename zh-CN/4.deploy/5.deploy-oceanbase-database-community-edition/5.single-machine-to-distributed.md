# 单机部署在线转分布式（手动部署）

OceanBase 数据库为单机分布式一体化架构，支持单机在线转分布式部署。本文以手动单机部署的数据库为例介绍如何通过命令行在线将单机部署的集群转为分布式集群。

## 前提条件

准备两台服务器，用来做扩容准备。需要确认以下信息：

* 服务器满足软硬件要求。详细信息请参考 [软硬件要求](2.local-deployment/1.requirements-for-software-and-hardware.md)。

* 生产环境下，服务器已进行环境和配置检查，具体操作请参考 [部署前配置](2.local-deployment/2.environment-and-configuration-checks.md)。

* 服务器中存在 OceanBase 数据库对应版本的 RPM 包，可从 [OceanBase 社区下载中心](https://www.oceanbase.com/softwarecenter) 自行下载。

## 操作步骤

### 步骤一：部署 OBServer 节点

在两台机器中分别执行以下步骤。

1. 安装 OceanBase 数据库 RPM 包。

   在 OceanBase 数据库 RPM 包所在目录下执行如下命令：

   ```shell
   [admin@obtest004 rpm]$ sudo rpm -ivh oceanbase-4.1.0.0-100000682023020119.el7.x86_64.rpm
   Preparing...                          ################################# [100%]
   Updating / installing...
      1:oceanbase-4.1.0.0-100000682023020################################# [100%]
   ```

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>软件包默认安装目录是 <code>/home/admin/oceanbase</code>。</p>
   </main>

2. （可选）清理目录。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>首次部署不需要执行此操作，此操作主要用于安装部署失败后。安装部署失败后需要在清空目录和数据后重新部署。</p>
   </main>

   示例如下：

   ```shell
   [admin@obtest ~]$ kill -9 `pidof observer`
   [admin@obtest ~]$ rm -rf ~/oceanbase/store/obdemo/*/*
   ```

   命令完成之后检查目录结构，确认是否和初始化之后的目录结构一致。

   ```bash
   [admin@obtest003 ~]$ tree ~/oceanbase/store/ /data/ /redo/
   
   # 输出
   /home/admin/oceanbase/store/
   └── obdemo
       ├── clog -> /redo/obdemo/clog
       ├── etc2 -> /redo/obdemo/etc2
       ├── etc3 -> /data/obdemo/etc3
       ├── slog -> /data/obdemo/slog
       └── sstable -> /data/obdemo/sstable
   /data/
   └── obdemo
       ├── etc3
       ├── slog
       └── sstable
   /redo/
   └── obdemo
       ├── clog
       └── etc2

   13 directories, 0 files
   ```

3. 初始化 OceanBase 目录。

   手动部署时，OceanBase 节点上的相关目录均需要手动创建。OceanBase 的数据目录建议创建在独立的磁盘上，然后通过软链接方式链接到软件 Home 目录下面。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>此操作仅需在首次部署时执行。</p>
   </main>

   示例如下：

   ```shell
   [admin@obtest ~]$ sudo mkdir -p ~/oceanbase/store/obdemo  /data/obdemo/{sstable,slog,etc3} /redo/obdemo/{clog,etc2}
   [admin@obtest ~]$ sudo chown admin:admin -R ~/oceanbase/
   [admin@obtest ~]$ sudo chown admin:admin -R /data
   [admin@obtest ~]$ sudo chown admin:admin -R /redo
   [admin@obtest ~]$ for f in {clog,etc2}; do ln -s /redo/obdemo/$f ~/oceanbase/store/obdemo/$f ; done
   [admin@obtest ~]$ for f in {sstable,slog,etc3}; do ln -s /data/obdemo/$f ~/oceanbase/store/obdemo/$f; done
   ```

   需要注意的是：

   * 您需创建工作目录下的总数据目录 `~/oceanbase/store/obdemo`、数据文件目录 `/data/obdemo` 和日志相关目录 `/redo/obdemo`。与使用 OBD 自动化部署的 OceanBase 集群节点目录相比，不同的是目录里加入了集群名标识（本文示例中为 `obdemo`）。

   * `~/oceanbase/store/obdemo` 是真实的目录，该目录下的子目录是映射到其他两个文件系统的路径（指 `/data/` 和 `/redo/`）。生产环境要求这两个文件系统尽可能是两块独立的物理盘，最低要求是两个独立的逻辑盘。

   初始化后的目录结构很重要，有时候 observer 进程启动失败就和目录结构和权限不对有关。目录结构如下：

   ```bash
   [admin@test ~]$ tree ~/oceanbase/store/ /data/ /redo/
   /home/admin/oceanbase/store/
   └── obdemo
       ├── clog -> /redo/obdemo/clog
       ├── etc2 -> /redo/obdemo/etc2
       ├── etc3 -> /data/obdemo/etc3
       ├── slog -> /data/obdemo/slog
       └── sstable -> /data/obdemo/sstable
   /data/
   └── obdemo
       ├── etc3
       ├── slog
       └── sstable
   /redo/
   └── obdemo
       ├── clog
       └── etc2

   13 directories, 0 files
   ```

4. 启动 observer 进程。

   您需在 admin 用户下启动 observer 进程，每个机器的启动参数大部分都相同，只有少数不一样，需要特别留意。

   示例如下：

   1. 启动 `10.10.10.2` 机器上的 observer 进程。

      ```shell
      [admin@test002 ~]$ echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:~/oceanbase/lib' >> ~/.bash_profile
      [admin@test002 ~]$ source ~/.bash_profile
      [admin@test002 ~]$ cd ~/oceanbase && bin/observer -i eth0 -p 2881 -P 2882 -z zone2 -d ~/oceanbase/store/obdemo -r '10.10.10.2:2882:2881' -c 10001 -n obdemo -o "memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2"
      # 输出
      bin/observer -i eth0 -p 2881 -P 2882 -z zone2 -d /home/admin/oceanbase/store/obdemo -r 10.10.10.2:2882:2881 -c 10001 -n obdemo -o memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2
      devname: eth0
      mysql port: 2881
      rpc port: 2882
      zone: zone2
      data_dir: /home/admin/oceanbase/store/obdemo
      rs list: 10.10.10.2:2882:2881
      cluster id: 10001
      appname: obdemo
      optstr: memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M    cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2
      ```

   2. 启动 `10.10.10.3` 机上的 observer 进程。

      ```shell
      [admin@test003 ~]$ echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:~/oceanbase/lib' >> ~/.bash_profile
      [admin@test003 ~]$ source ~/.bash_profile
      [admin@test003 ~]$ cd ~/oceanbase && bin/observer -i eth0 -p 2881 -P 2882 -z zone3 -d ~/oceanbase/store/obdemo -r '10.10.10.3:2882:2881' -c 10001 -n obdemo -o "memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2"
      # 输出
      bin/observer -i eth0 -p 2881 -P 2882 -z zone3 -d /home/admin/oceanbase/store/obdemo -r 10.10.10.3:2882:2881 -c 10001 -n obdemo -o memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2
      devname: eth0
      mysql port: 2881
      rpc port: 2882
      zone: zone3
      data_dir: /home/admin/oceanbase/store/obdemo
      rs list: 10.10.10.3:2882:2881
      cluster id: 10001
      appname: obdemo
      optstr: memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2
      ```

   命令串中 `-o` 参数不是必须的，此处因为测试机器内存不足，所以需要指定一些影响内存的参数。如果您的机器内存足够（如大于 64 GB），则可以省去 `-o` 参数部分。其中，`-c` 参数用于指定集群 ID，`-n` 参数用于指定集群名称。

5. 查看 observer 进程是否启动成功。

   可以通过下面两种方法查看 observer 进程是否启动成功：

   * 执行 `netstat -ntlp` 命令，如果监听到了 `2881` 与 `2882` 端口，则说明进程启动成功。

   * 执行 `ps -ef | grep observer` 命令可以返回 observer 进程信息。

   示例如下：

   ```shell
   [admin@obtest003 ~]$ netstat -ntpl
   (Not all processes could be identified, non-owned process info
    will not be shown, you would have to be root to see it all.)
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
   tcp        0      0 0.0.0.0:2881            0.0.0.0:*               LISTEN      20172/bin/observer
   tcp        0      0 0.0.0.0:2882            0.0.0.0:*               LISTEN      20172/bin/observer
   ...       ...     ...                       ...                     ...         ...

   [admin@obtest003 ~]$ ps -ef | grep observer
   admin    20172     1 14 11:32 ?        00:28:12 bin/observer -i eth0 -p 2881 -P 2882 -z zone1 -d /home/admin/oceanbase/store/obdemo -r 172.30.199.251:2882:2881;172.30.199.252:2882:2881;172.30.199.253:2882:2881 -c 20230130 -n obdemo -o memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2
   admin    20864 20840  0 14:45 pts/1    00:00:00 grep --color=auto observer
   ```

### 步骤二：集群扩容

1. 使用 root 用户登录集群的 sys 租户。
    <!-- 需等社区版包出来后替换为社区版操作输出 -->
    ```shell
    [admin@obtest001 ~]$ obclient -h10.10.10.1 -P2881 -uroot@sys -p
    Enter password:
    Welcome to the OceanBase.  Commands end with ; or \g.
    Your OceanBase connection id is 3221490218
    Server version: OceanBase 4.1.0.0 (r100000682023020119-c760cbb1023d73a2647f28add283646b1569418f) (Built Feb  1 2023 20:07:36)

    Copyright (c) 2000, 2018, OceanBase and/or its affiliates. All rights reserved.

    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

    obclient [(none)]>
    ```

2. 向集群中增加 Zone。

    新增名为 `zone2` 和 `zone3` 的 Zone，示例如下：

    ```shell
    obclient [(none)]> ALTER SYSTEM ADD ZONE zone2;
    Query OK, 0 rows affected

    obclient [(none)]> ALTER SYSTEM ADD ZONE zone3;
    Query OK, 0 rows affected
    ```

3. 启动 `zone2` 和 `zone3`。

    启动新增加的 Zone，示例如下：

    ```shell
    obclient [(none)]> ALTER SYSTEM START ZONE zone2;
    Query OK, 0 rows affected

    obclient [(none)]> ALTER SYSTEM START ZONE zone3;
    Query OK, 0 rows affected
    ```

    命令使用详情请参考 [ZONE](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/2.alter-system/25.zone.md)。

4. 向集群中添加 OBServer 节点。

    将 **步骤一** 中部署的两个 OBServer 节点分别添加至 `zone2` 和 `zone3`。

    示例如下：

    ```shell
    obclient [(none)]> ALTER SYSTEM ADD SERVER '10.10.10.2:2882' ZONE 'zone2';
    Query OK, 0 rows affected

    obclient [(none)]> ALTER SYSTEM ADD SERVER '10.10.10.3:2882' ZONE 'zone3';
    Query OK, 0 rows affected
    ```

    命令使用详情请参考 [SERVER](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/2.alter-system/20.SERVER.md)。

5. 查看 OBServer 节点是否添加成功。

    添加 OBServer 节点后，可以执行以下语句，确认列表中是否有刚才添加的 OBServer 节点，如果有，则表示添加成功。

    ```shell
    obclient [(none)]> SELECT SVR_IP,SVR_PORT,ID,ZONE,SQL_PORT,STATUS,START_SERVICE_TIME FROM oceanbase.DBA_OB_SERVERS;
    +----------------+----------+----+-------+----------+--------+----------------------------+
    | SVR_IP         | SVR_PORT | ID | ZONE  | SQL_PORT | STATUS | START_SERVICE_TIME         |
    +----------------+----------+----+-------+----------+--------+----------------------------+
    | 10.10.10.3     |     2882 |  3 | zone3 |     2881 | ACTIVE | 2023-03-03 17:26:44.207835 |
    | 10.10.10.2     |     2882 |  2 | zone2 |     2881 | ACTIVE | 2023-03-03 17:25:47.772032 |
    | 10.10.10.1     |     2882 |  1 | zone1 |     2881 | ACTIVE | 2023-03-03 10:09:27.040795 |
    +----------------+----------+----+-------+----------+--------+----------------------------+
    3 rows in set
    ```

### 步骤三：租户扩副本

1. 使用 root 用户登录集群的 sys 租户。

    ```shell
    [admin@obtest001 ~]$ obclient -h10.10.10.1 -P2881 -uroot@sys -p
    Enter password:
    Welcome to the OceanBase.  Commands end with ; or \g.
    Your OceanBase connection id is 3221490218
    Server version: OceanBase 4.1.0.0 (r100000682023020119-c760cbb1023d73a2647f28add283646b1569418f) (Built Feb  1 2023 20:07:36)

    Copyright (c) 2000, 2018, OceanBase and/or its affiliates. All rights reserved.

    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

    obclient [(none)]>
    ```

2. 修改资源池的 `ZONE_LIST`。

    将新增加的 Zone 添加进租户的资源池中，示例如下：

    ```shell
    obclient [(none)]> ALTER RESOURCE POOL pool001 ZONE_LIST=('zone1','zone2','zone3');
    Query OK, 0 rows affected
    ```

    `ALTER RESOURCE POOL` 语句的详细说明请参见 [ALTER RESOURCE POOL](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/3.alter-resource-pool.md)

3. 增加租户的副本。

    <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>对租户修改 Locality 增加副本时，需要一个一个增加。</p>
    </main>

    ```shell
    obclient [(none)]> ALTER TENANT tenant_001 LOCALITY='F@zone1,F@zone2';
    Query OK, 0 rows affected

    obclient [(none)]> ALTER TENANT tenant_001 LOCALITY='F@zone1,F@zone2,F@zone3';
    Query OK, 0 rows affected
    ```

    `ALTER TENANT` 语句的详细说明请参见 [ALTER TENANT](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/5.alter-tenant.md)。
