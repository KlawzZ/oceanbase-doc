# 单机部署在线转分布式（OBD 部署）

OceanBase 数据库为单机分布式一体化架构，支持单机在线转分布式部署。本文以使用 OBD 单机部署的数据库为例介绍如何通过命令行在线将单机部署的集群转为分布式集群。

## 前提条件

准备两台服务器，用来做扩容准备。需要确认以下信息：

* 服务器满足软硬件要求。详细信息请参考 [软硬件要求](2.local-deployment/1.requirements-for-software-and-hardware.md)。

* 生产环境下，服务器已进行环境和配置检查，具体操作请参考 [部署前配置](2.local-deployment/2.environment-and-configuration-checks.md)。

## 操作步骤

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>本节示例中单机部署的数据库名为 obtest，为扩容新部署的集群名为 ob_new，您可根据实际情况命名。</p>
</main>

### 步骤一：部署 OBServer 节点

1. 选择配置文件

   若中控机中的 OBD 是通过直接下载的方式安装，则可在 `/usr/obd/example` 目录下查看 OBD 提供的配置文件示例。

   若中控机中的 OBD 是通过安装 all-in-one 安装包的方式安装，则可在 `ooceanbase-all-in-one/conf` 目录下查看 OBD 提供的配置文件示例。请根据您的资源条件选择相应的配置文件。

   小规格开发模式，适用于个人设备（内存不低于 8 GB）

   * 分布式部署配置样例：mini-distributed-example.yaml

   * 分布式部署 + ODP 配置样例：mini-distributed-with-obproxy-example.yaml

   * 分布式部署 + ODP + 监控配置样例：all-components-min.yaml
  
   专业开发模式，适用于高配置 ECS 或物理服务器（可用资源不低于 16 核 64 GB）

   * 分布式部署配置样例：distributed-example.yaml

   * 分布式部署 + ODP 配置样例：distributed-with-obproxy-example.yaml

   * 分布式部署 + ODP + 监控配置样例：all-components.yaml

2. 修改配置文件

   此处以小规格开发模式-分布式部署（mini-single-example.yaml）为例，介绍如何修改配置文件。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>您需根据您环境的真实情况修改下述参数。</p>
   </main>

   1. 修改用户信息

      ```yaml
      ## Only need to configure when remote login is required
      user:
        username: admin
      #   password: your password if need
        key_file: /home/admin/.ssh/id_rsa
      #   port: your ssh port, default 22
      #   timeout: ssh connection timeout (second), default 30
      ```

      `username` 为登录到目标机器的用户名，确保您的用户名有 `home_path` 的写权限。`password` 和 `key_file` 均用于验证用户，通常情况下只需要填写一个。

      <main id="notice" type='notice'>
        <h4>注意</h4>
        <p>在配置秘钥路径后，如果您的秘钥不需要口令，请注释或者删除 <code>password</code>，以免 <code>password</code> 被视为秘钥口令用于登录，导致校验失败。。</p>
      </main>

   2. 修改机器的 IP、端口和相关目录，并配置内存相关参数

      ```yaml
      oceanbase-ce:
        servers:
          - name: server2
            # Please don't use hostname, only IP can be supported
            ip: 10.10.10.2
          - name: server3
            ip: 10.10.10.3
        global:
          # Please set devname as the network adaptor's name whose ip is  in the setting of severs.
          # if set severs as "127.0.0.1", please set devname as "lo"
          # if current ip is 192.168.1.10, and the ip's network adaptor's name is "eth0", please use "eth0"
          devname: eth0
          memory_limit: 6G # The maximum running memory for an observer
          system_memory: 1G # The reserved system memory. system_memory is reserved for general tenants. The default value is 30G.
          datafile_size: 20G # Size of the data file.
          log_disk_size: 24G # The size of disk space used by the clog files.
          cpu_count: 16
          production_mode: false
          mysql_port: 2881 # External port for OceanBase Database. The default value is 2881. DO NOT change this value after the cluster is started.
          rpc_port: 2882 # Internal port for OceanBase Database. The default value is 2882. DO NOT change this value after the cluster is started.
          #  The working directory for OceanBase Database. OceanBase Database is started under this directory. This is a required field.
          home_path: /home/admin/observer
          # The directory for data storage. The default value is $home_path/store.
          data_dir: /data
          # The directory for clog, ilog, and slog. The default value is the same as the data_dir value.
          redo_dir: /redo
        server2:
          zone: zone2
        server3:
          zone: zone3
      ```

      若两台机器中存在不一致的配置项，可将该配置项移到对应 server 里进行配置，以两台机器中配置端口不同为例：

      ```yaml
      server2:
        mysql_port: 3881
        rpc_port: 3882
        zone: zone2
      server3:
        mysql_port: 2881
        rpc_port: 2882
        zone: zone3 
      ```

3. 使用 OBD 部署新集群

   ```bash
   [admin@test001 ~]$ obd cluster deploy ob_new -c mini-distributed-example.yaml
   ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>扩容过程中只需部署新集群，无需启动该集群。</p>
   </main>

4. 将新集群的配置文件复制到原集群配置文件中

   执行如下命令打开原集群配置文件，将新集群配置文件中的内容分别复制到对应位置处。

   ```bash
   # 查看集群配置文件存放路径
   [admin@test001 ~]$ obd cluster list
   # 打开原集群配置文件
   [admin@test001 ~]$ vim ~/.obd/cluster/obtest/config.yaml
   ```

   修改后的配置文件示例如下：

   ```yaml
   ## Only need to configure when remote login is required
   user:
     username: admin
     #   password: your password if need
     key_file: /home/admin/.ssh/id_rsa
     #   port: your ssh port, default 22
     #   timeout: ssh connection timeout (second), default 30
   oceanbase-ce:
     servers:
       - name: server1
         # Please don't use hostname, only IP can be supported
         ip: 10.10.10.1
       - name: server2
         ip: 10.10.10.2
       - name: server3
         ip: 10.10.10.3
     global:
       devname: eth0
       memory_limit: 6G # The maximum running memory for an observer
       system_memory: 1G # The reserved system memory. system_memory is reserved for general tenants. The default value is 30G.
       datafile_size: 20G # Size of the data file.
       log_disk_size: 24G # The size of disk space used by the clog files.
       cpu_count: 16
       production_mode: false
       mysql_port: 2881 # External port for OceanBase Database. The default value is 2881.
       rpc_port: 2882 # Internal port for OceanBase Database. The default value is 2882.
       home_path: /home/admin/observer
       data_dir: /data
       redo_dir: /redo
       root_password: ****** # root user password, can be empty
       proxyro_password: ****** # proxyro user pasword, consistent with obproxy's observer_sys_password, can be empty
     serverz1:
       zone: zone1
     server2:
       zone: zone2
     server3:
       zone: zone3
   obproxy-ce:
       depends:
         - oceanbase-ce
       servers:
         - 10.10.10.1
       global:
       listen_port: 2883 # External port. The default value is 2883.
       prometheus_listen_port: 2884 # The Prometheus port. The default value is 2884.
       home_path: /home/amber/obproxy
       enable_cluster_checkout: false
       skip_proxy_sys_private_check: true
       enable_strict_kernel_release: false
       obproxy_sys_password: ****** # obproxy sys user password, can be empty
       observer_sys_password: ****** # proxyro user pasword, consistent with oceanbase-ce's proxyro_password, can be empty
   ```

5. 启动原集群

   ```bash
   [admin@test001 ~]$ obd cluster start obtest
   ```

6. 删除新集群的配置文件

   为防止以后误操作将新拉起的 OBServer 节点删除，需执行如下命令将新集群的配置文件删除。

   ```bash
   # 查看集群配置文件存放路径
   [admin@test001 ~]$ obd cluster list
   # 删除新集群配置文件
   [admin@test001 ~]$ rm -rf ~/.obd/cluster/ob_new

### 步骤二：集群扩容

1. 使用 root 用户登录集群的 sys 租户。
    <!-- 需等社区版包出来后替换为社区版操作输出 -->
    ```shell
    [admin@obtest001 ~]$ obclient -h10.10.10.1 -P2883 -uroot@sys -p
    Enter password:
    Welcome to the OceanBase.  Commands end with ; or \g.
    Your OceanBase connection id is 3221490218
    Server version: OceanBase 4.1.0.0 (r100000682023020119-c760cbb1023d73a2647f28add283646b1569418f) (Built Feb  1 2023 20:07:36)

    Copyright (c) 2000, 2018, OceanBase and/or its affiliates. All rights reserved.

    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

    obclient [(none)]>
    ```

2. 向集群中增加 Zone。

    新增名为 `zone2` 和 `zone3` 的 Zone，示例如下：

    ```shell
    obclient [(none)]> ALTER SYSTEM ADD ZONE zone2;
    Query OK, 0 rows affected

    obclient [(none)]> ALTER SYSTEM ADD ZONE zone3;
    Query OK, 0 rows affected
    ```

3. 启动 `zone2` 和 `zone3`。

    启动新增加的 Zone，示例如下：

    ```shell
    obclient [(none)]> ALTER SYSTEM START ZONE zone2;
    Query OK, 0 rows affected

    obclient [(none)]> ALTER SYSTEM START ZONE zone3;
    Query OK, 0 rows affected
    ```

    命令使用详情请参考 [ZONE](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/2.alter-system/25.zone.md)。

4. 向集群中添加 OBServer 节点。

    将 **步骤一** 中部署的两个 OBServer 节点分别添加至 `zone2` 和 `zone3`。

    示例如下：

    ```shell
    obclient [(none)]> ALTER SYSTEM ADD SERVER '10.10.10.2:2882' ZONE 'zone2';
    Query OK, 0 rows affected

    obclient [(none)]> ALTER SYSTEM ADD SERVER '10.10.10.3:2882' ZONE 'zone3';
    Query OK, 0 rows affected
    ```

    命令使用详情请参考 [SERVER](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/2.alter-system/20.SERVER.md)。

5. 查看 OBServer 节点是否添加成功。

    添加 OBServer 节点后，可以执行以下语句，确认列表中是否有刚才添加的 OBServer 节点，如果有，则表示添加成功。

    ```shell
    obclient [(none)]> SELECT SVR_IP,SVR_PORT,ID,ZONE,SQL_PORT,STATUS,START_SERVICE_TIME FROM oceanbase.DBA_OB_SERVERS;
    +----------------+----------+----+-------+----------+--------+----------------------------+
    | SVR_IP         | SVR_PORT | ID | ZONE  | SQL_PORT | STATUS | START_SERVICE_TIME         |
    +----------------+----------+----+-------+----------+--------+----------------------------+
    | 10.10.10.3     |     2882 |  3 | zone3 |     2881 | ACTIVE | 2023-03-03 17:26:44.207835 |
    | 10.10.10.2     |     2882 |  2 | zone2 |     2881 | ACTIVE | 2023-03-03 17:25:47.772032 |
    | 10.10.10.1     |     2882 |  1 | zone1 |     2881 | ACTIVE | 2023-03-03 10:09:27.040795 |
    +----------------+----------+----+-------+----------+--------+----------------------------+
    3 rows in set
    ```

### 步骤三：租户扩副本

1. 使用 root 用户登录集群的 sys 租户。

    ```shell
    [admin@test001 ~]$ obclient -h10.10.10.1 -P2883 -uroot@sys -p
    Enter password:
    Welcome to the OceanBase.  Commands end with ; or \g.
    Your OceanBase connection id is 3221490218
    Server version: OceanBase 4.1.0.0 (r100000682023020119-c760cbb1023d73a2647f28add283646b1569418f) (Built Feb  1 2023 20:07:36)

    Copyright (c) 2000, 2018, OceanBase and/or its affiliates. All rights reserved.

    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

    obclient [(none)]>
    ```

2. 修改资源池的 `ZONE_LIST`。

    将新增加的 Zone 添加进租户的资源池中，示例如下：

    ```shell
    obclient [(none)]> ALTER RESOURCE POOL pool001 ZONE_LIST=('zone1','zone2','zone3');
    Query OK, 0 rows affected
    ```

    `ALTER RESOURCE POOL` 语句的详细说明请参见 [ALTER RESOURCE POOL](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/3.alter-resource-pool.md)

3. 增加租户的副本。

    <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>对租户修改 Locality 增加副本时，需要一个一个增加。</p>
    </main>

    ```shell
    obclient [(none)]> ALTER TENANT tenant_001 LOCALITY='F@zone1,F@zone2';
    Query OK, 0 rows affected

    obclient [(none)]> ALTER TENANT tenant_001 LOCALITY='F@zone1,F@zone2,F@zone3';
    Query OK, 0 rows affected
    ```

    `ALTER TENANT` 语句的详细说明请参见 [ALTER TENANT](../../7.reference/4.development-reference/1.sql-syntax/1.system-tenants/5.alter-tenant.md)。
