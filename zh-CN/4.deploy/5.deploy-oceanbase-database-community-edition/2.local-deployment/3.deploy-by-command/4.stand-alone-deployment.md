# 单机部署 OceanBase 数据库

OceanBase 数据库支持单机部署。单机部署仅包含一个 Zone 并且 Zone 中只有一个 OBServer 节点。支持单机部署在线转分布式部署。

本文主要介绍如何通过 RPM 包部署单机 OceanBase 数据库。

## 前提条件

在安装 OceanBase 数据库之前，需要确认以下信息：

* 您的机器满足软硬件要求。详细信息请参考 [软硬件要求](1.requirements-for-software-and-hardware.md)。

* 生产环境下，您需要进行环境和配置检查，具体操作请参考 [部署前配置](2.environment-and-configuration-checks.md)。

* 您的机器中已提前下载所需版本的安装包，软件下载地址：[OceanBase 软件下载中心](https://www.oceanbase.com/softwarecenter)。

* 您的机器中已安装 OBClient 客户端，详细信息请参考 [OBClient 文档](https://github.com/oceanbase/obclient/blob/master/README.md)。

## 操作步骤

### 步骤一：安装 RPM 包

您可通过如下命令安装 OceanBase 数据库 RPM 包。

```shell
[admin@test001 ~]$ cd $rpm_dir
[admin@test001 $rpm_dir]$ sudo rpm -ivh $rpm_name
```

其中 `$rpm_dir` 表示存放 RPM 包的目录，`$rpm_name` 表示 RPM 包的名称。

<main id="notice" type='explain'>
   <h4>说明</h4>
   <p>OceanBase 数据库软件会默认安装在目录 <code>/home/admin/oceanbase</code> 下。</p>
</main>

示例如下：

```shell
[admin@test001 ~]$ sudo rpm -ivh oceanbase-ce-*.rpm
Preparing...                          ################################# [100%]
Updating / installing...
   1:oceanbase-ce-libs-4.1.0.0-1000001################################# [ 50%]
   2:oceanbase-ce-4.1.0.0-100000172023################################# [100%]
```

### 步骤二：配置目录

1. （可选）清理目录。

   新机器第一次部署 OceanBase 数据库时不用清理目录，此操作主要用于安装部署失败后。安装部署失败后需要在清空目录和数据后重新部署。

   ```shell
   [admin@test001 ~]$ kill -9 `pidof observer`
   [admin@test001 ~]$ rm -rf /home/admin/oceanbase/store/$cluster_name/*/* 
   ```

   其中 `$cluster_name` 为集群名。

   示例如下：

   ```shell
   [admin@test001 ~]$ kill -9 `pidof observer`
   [admin@test001 ~]$ rm -rf ~/oceanbase/store/obdemo/*/*
   ```

   命令完成之后检查目录结构，确认是否和初始化之后的目录结构一致。

   ```bash
   [admin@test001 ~]$ tree ~/oceanbase/store/ /data/ /redo/
   
   # 输出
   /home/admin/oceanbase/store/
   └── obdemo
       ├── clog -> /redo/obdemo/clog
       ├── etc2 -> /redo/obdemo/etc2
       ├── etc3 -> /data/obdemo/etc3
       ├── slog -> /data/obdemo/slog
       └── sstable -> /data/obdemo/sstable
   /data/
   └── obdemo
       ├── etc3
       ├── slog
       └── sstable
   /redo/
   └── obdemo
       ├── clog
       └── etc2

   13 directories, 0 files
   ```

2. 初始化 OceanBase 目录。

   手动部署时，OceanBase 节点上的相关目录均需要手动创建。OceanBase 的数据目录建议创建在独立的磁盘上，然后通过软链接方式链接到软件 Home 目录下面。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>此操作仅需在首次部署时执行。</p>
   </main>

   ```shell
   ##使用 admin 用户执行以下命令##
   [admin@test001 ~]$ sudo mkdir -p ~/oceanbase/store/$cluster_name  /data/$cluster_name/{sstable,slog,etc3} /redo/$cluster_name/{clog,etc2}
   [admin@test001 ~]$ sudo chown admin:admin -R ~/oceanbase/
   [admin@test001 ~]$ sudo chown admin:admin -R /data
   [admin@test001 ~]$ sudo chown admin:admin -R /redo
   [admin@test001 ~]$ for f in {clog,etc2}; do ln -s /redo/$cluster_name/$f ~/oceanbase/store/$cluster_name/$f ; done
   [admin@test001 ~]$ for f in {sstable,slog,etc3}; do ln -s /data/$cluster_name/$f ~/oceanbase/store/$cluster_name/$f; done
   ```

   其中 `$cluster_name` 为集群名。

   示例如下：

   ```shell
   [admin@test001 ~]$ sudo mkdir -p ~/oceanbase/store/obdemo  /data/obdemo/{sstable,slog,etc3} /redo/obdemo/{clog,etc2}
   [admin@test001 ~]$ sudo chown admin:admin -R ~/oceanbase/
   [admin@test001 ~]$ sudo chown admin:admin -R /data
   [admin@test001 ~]$ sudo chown admin:admin -R /redo
   [admin@test001 ~]$ for f in {clog,etc2}; do ln -s /redo/obdemo/$f ~/oceanbase/store/obdemo/$f ; done
   [admin@test001 ~]$ for f in {sstable,slog,etc3}; do ln -s /data/obdemo/$f ~/oceanbase/store/obdemo/$f; done
   ```

   需要注意的是：

   * 您需创建工作目录下的总数据目录 `~/oceanbase/store/obdemo`、数据文件目录 `/data/obdemo` 和日志相关目录 `/redo/obdemo`。与使用 OBD 自动化部署的 OceanBase 集群节点目录相比，不同的是目录里加入了集群名标识（本文示例中为 `obdemo`）。

   * `~/oceanbase/store/obdemo` 是真实的目录，该目录下的子目录是映射到其他两个文件系统的路径（指 `/data/` 和 `/redo/`）。生产环境要求这两个文件系统尽可能是两块独立的物理盘，最低要求是两个独立的逻辑盘。

   初始化后的目录结构很重要，有时候 observer 进程启动失败就和目录结构和权限不对有关。目录结构如下：

   ```bash
   [admin@test001 ~]$ tree ~/oceanbase/store/ /data/ /redo/
   /home/admin/oceanbase/store/
   └── obdemo
       ├── clog -> /redo/obdemo/clog
       ├── etc2 -> /redo/obdemo/etc2
       ├── etc3 -> /data/obdemo/etc3
       ├── slog -> /data/obdemo/slog
       └── sstable -> /data/obdemo/sstable
   /data/
   └── obdemo
       ├── etc3
       ├── slog
       └── sstable
   /redo/
   └── obdemo
       ├── clog
       └── etc2

   13 directories, 0 files
   ```

### 步骤三：初始化 OceanBase 数据库

<main id="notice" type='explain'>
   <h4>说明</h4>
   <p>示例 IP 做了脱敏处理，这不是安装需求。在部署时应根据自己机器真实 IP 填写。</p>
</main>

1. 启动 observer 进程。

   须在 admin 用户下启动 observer 进程。

   示例如下：

   ```shell
   [admin@test001 ~]$ echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:~/oceanbase/lib' >> ~/.bash_profile
   [admin@test001 ~]$ source ~/.bash_profile
   [admin@test001 ~]$ cd ~/oceanbase && bin/observer -i eth0 -p 2881 -P 2882 -z zone1 -d ~/oceanbase/store/obdemo -r '10.10.10.1:2882:2881' -c 10001 -n obdemo -o "memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2"

   **参数解释：**

   |**参数**|               **说明**     |
   |--------|----------------------------|
   | `-i`   | 指定网卡名，可通过 `ifconfig` 命令查看。|
   | `-p`   | 指定服务端口号，一般指定为 `2881`。|
   | `-P`   | 指定 RPC 端口号，一般指定为 `2882`。|
   | `-n`   | 指定集群名称。可自定义，不同集群名称不要重复即可。|
   | `-z`   | 指定启动的 observer 进程所属的 Zone。|
   | `-d`   | 指定集群主目录，初始化目录时创建的目录。除集群名字 `obdemo` 外，其他不要变动。|
   | `-c`   | 指定集群 ID。为一组数字，可以自定义，不同集群不要重复即可。|
   | `-r`   | 指定 RS 列表，格式是 `ip:2882:2881`，分号分割，表示 Root Service 信息。|
   | `-o`   | 指定集群启动参数，需要根据实际情况设置。`-o` 参数不是必须的，此处因为测试机器内存不足，所以需要指定一些影响内存的参数。如果您的机器内存足够（如大于 64 GB），则可以省去 `-o` 参数部分。|

   可以通过下面命令查看 observer 进程是否启动成功：

   * `netstat -ntlp` 命令，如果监听到了 `2881` 与 `2882` 端口，则说明进程启动成功。
   
   * `ps -ef | grep observer` 命令可以返回 observer 进程信息。

   示例如下：

   ```shell
   [admin@test001 ~]$ netstat -ntpl
   (Not all processes could be identified, non-owned process info
    will not be shown, you would have to be root to see it all.)
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
   tcp        0      0 0.0.0.0:2881            0.0.0.0:*               LISTEN      17676/bin/observer
   tcp        0      0 0.0.0.0:2882            0.0.0.0:*               LISTEN      17676/bin/observer
   ...       ...     ...                       ...                     ...         ...

   [admin@test001 ~]$ ps -ef | grep observer
   admin    17676     1 19 16:25 ?        00:00:05 bin/observer -i eth0 -p 2881 -P 2882 -z zone1 -d /home/admin/oceanbase/store/obdemo -r 10.10.10.1:2882:2881 -c 10001 -n obdemo -o memory_limit=8G,cache_wash_threshold=1G,__min_full_resource_pool_memory=1073741824,system_memory=3G,memory_chunk_cache_size=128M,cpu_count=16,net_thread_count=4,datafile_size=30G,stack_size=1536K,config_additional_dir=/data/obdemo/etc3;/redo/obdemo/etc2
   admin    20864 20840  0 14:45 pts/1    00:00:00 grep --color=auto observer
   ```

2. 集群 bootstrap 操作。

   通过 OBClient 客户端连接已启动的 observer 进程，密码为空。

   ```shell
   [admin@obtest001 oceanbase]$ obclient -h127.1 -uroot@sys -P2881 -p
   Enter password:
   Welcome to the OceanBase.  Commands end with ; or \g.
   Your OceanBase connection id is 3221225698
   Server version: OceanBase_CE 4.1.0.0 (r100000172023031416-6d4641c7bcd0462f0bf3faed011803c087ea1705) (Built Mar 14 2023 16:53:58)

   Copyright (c) 2000, 2018, OceanBase and/or its affiliates. All rights reserved.

   Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

   obclient [(none)]> SET SESSION ob_query_timeout=1000000000;
   Query OK, 0 rows affected (0.001 sec)

   obclient [(none)]> ALTER SYSTEM BOOTSTRAP ZONE 'zone1' SERVER '10.10.10.1:2882';
   Query OK, 0 rows affected
   ```

   <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>如果这一步失败报错了，其原因很可能是 observer 进程启动参数有不对、OBServer 节点相关目录权限不对、日志目录空间不足一定比例（跟数据目录合用了大目录，空间被数据目录占用了）节点内存资源不足等等。请先排查这些问题点，然后清理 OceanBase 目录从头开始。</p>
   </main>

3. 验证集群初始化成功。

   进行 bootstrap 后，执行 `SHOW DATABASES;` 命令，能看到数据库列表里有 `oceanbase` 库即可。

   ```shell
   obclient [(none)]> SHOW DATABASES;
   +--------------------+
   | Database           |
   +--------------------+
   | information_schema |
   | LBACSYS            |
   | mysql              |
   | oceanbase          |
   | ORAAUDITOR         |
   | SYS                |
   | test               |
   +--------------------+
   7 rows in set
   ```

4. 修改密码。

   `sys` 租户的 `root` 用户密码默认为空，初始化成功后请修改密码。

   ```shell
   obclient [(none)]> ALTER USER root IDENTIFIED BY '******';
   Query OK, 0 rows affected
   ```

### 步骤四：创建用户租户

1. 查看集群资源信息。

   ```shell
   obclient [oceanbase]> use oceanbase;
   Database changed
   obclient [oceanbase]> SELECT SVR_IP,ZONE,(CPU_CAPACITY-CPU_ASSIGNED) cpu_free,round((MEM_CAPACITY-MEM_ASSIGNED)/1024/1024/1024) mem_free_gb FROM GV$OB_SERVERS;
   +----------------+-------+----------+-------------+
   | SVR_IP         | ZONE  | cpu_free | mem_free_gb |
   +----------------+-------+----------+-------------+
   | 10.10.10.1     | zone1 |       15 |           4 |
   +----------------+-------+----------+-------------+
   1 row in set
   ```

2. 创建资源单元。

   创建资源单元 `unit001` 配置为 2 个 CPU，2 GB 内存。

   ```shell
   obclient [(none)]> CREATE RESOURCE UNIT unit001 MAX_CPU=2,MEMORY_SIZE='2G';
   Query OK, 0 rows affected
   ```

3. 创建资源池。

   使用 `unit001` 的规格创建资源池 `pool001`。

   ```shell
   obclient [(none)]> CREATE RESOURCE POOL pool001 UNIT='unit001',UNIT_NUM=1,ZONE_LIST=('zone1');
   Query OK, 0 rows affected
   ```

4. 创建租户。

   创建租户 tenant001，并将资源池 `pool001` 分配给租户。

   ```shell
   obclient [(none)]> CREATE TENANT IF NOT EXISTS tenant001 CHARSET='utf8mb4',comment 'mysql tenant/instance',PRIMARY_ZONE='zone1',RESOURCE_POOL_LIST=('pool001') SET ob_tcp_invited_nodes='%';
   Query OK, 0 rows affected
   ```

5. 修改密码。

   通过命令行创建的 Oracle 模式租户，其管理员用户 `sys` 的密码默认为空，首次登录后请修改密码。

   ```shell
   [admin@obtest001 oceanbase]$ obclient -h127.1 -uroot@tenant001 -P2881 -p
   Enter password:
   Welcome to the OceanBase.  Commands end with ; or \g.
   Your OceanBase connection id is 3221497372
   Server version: OceanBase_CE 4.1.0.0 (r100000172023031416-6d4641c7bcd0462f0bf3faed011803c087ea1705) (Built Mar 14 2023 16:53:58)

   Copyright (c) 2000, 2018, OceanBase and/or its affiliates. All rights reserved.

   Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

   obclient [(none)]> ALTER USER root IDENTIFIED BY "******";
   Query OK, 0 rows affected
   ```
<!-- 需再确认是否要保留，保留的话需要修改链接 -->
## 相关文档

* [系统配置项总览](../../../7.reference/5.system-reference/1.system-configuration-items/2.system-configuration-items-overview-list.md)。
* [ALTER USER](../../../7.reference/4.development-reference/1.sql-syntax/2.common-tenant-of-mysql-mode/6.sql-statement-of-mysql-mode/8.alter-user-of-mysql-mode.md)。

* [创建租户](5.create-oceanbase-tenant-command-line/2.create-tenant.md)。

* [单机部署转分布式部署](5.single-machine-deployment-online-to-distributed.md)
