# 容灾部署方案

OceanBase 数据库提供多种部署模式，可根据对机房配置以及性能和可用性的需求进行灵活选择。

|   部署方案   |       容灾能力        |  RTO  | RPO  |
|----------|-------------------|-------|------|
| 同机房三副本       | 机器级无损容灾 / 机架级无损容灾 | 8s 内 | 0    |
| 同城双机房物理备库 | 机房级容灾               | 秒级   | 大于 0 |
| 同城三机房仲裁服务 | 机房级容灾               |        | 0   |
| 同城三机房三副本   | 机房级无损容灾           | 8s 内  | 0    |
| 两地两中心物理备库 | 地域级容灾               | 秒级   | 大于 0 |
| 三地三中心仲裁服务 |                         |        | 0  |
| 三地三中心五副本   | 地域级无损容灾           | 8s 内  | 0  |
| 三地五中心仲裁服务 | 地域级容灾               |        | 0  |
| 三地五中心五副本   | 地域级容灾               | 8s内   | 0  |

为了达到不同级别的容灾能力，OceanBase 数据库提供了多种高可用解决方案：多副本高可用解决方案、物理备库高可用以及仲裁高可用解决方案。多副本高可用解决方案基于 Paxos 协议实现，在少数派副本不可用情况下，能够自动恢复服务，并且不丢数据，始终保证 RTO 在 8 秒内，RPO 为 0。物理备库高可用解决方案是基于传统的主-备架构来实现的高可用方案，是多副本高可用方案的重要补充，可以满足双机房和双地域场景下的容灾需求；它不能保证数据不丢，RPO 大于 0，RTO 为秒级别。仲裁高可用解决方案不仅可以解决两地三中心同城副本故障时 RT 变大的问题，还能降低跨城带宽开销，并将第三机房的成本降到极低。

## 同机房三副本

如果只有一个机房，可以部署三副本或更多副本，来达到机器级无损容灾。当单台 server 或少数派 server 宕机情况下，不影响业务服务，不丢数据。如果一个机房内有多个机架，可以为每个机架部署一个 Zone，从而达到机架级无损容灾。

## 同城双机房物理备库

如果同城只有双机房，又想达到机房级容灾能力，可以采用物理备库，每个机房部署一个集群。当任何一个机房不可用时，另一个机房可以接管业务服务。如果备机房不可用，此时业务数据不受影响，可以持续提供服务；如果主机房不可用，备库需要激活成新主库，接管业务服务，由于备库不能保证同步所有数据，因此可能会丢失数据。

## 同城三机房仲裁服务

如果同城具备三机房条件，同城 3 个机房组成一个集群，机房间网络延迟一般在 0.5 ~ 2 ms 之间，其中两个机房部署全功能副本，分别作为一个 Zone，为了降低成本，第三机房部署仲裁服务（无需同步日志）。当发生机房级灾难时（全功能副本所在机房故障），剩余两个机房的副本可以选主、执行仲裁降级，继续同步 Redo-Log 日志，保证 RPO = 0。

## 同城三机房三副本

如果同城具备三机房条件，还可以为每个机房部署一个 Zone，从而达到机房级无损容灾能力。任何一个机房不可用时，可以利用剩下的两个机房继续提供服务，不丢失数据。这种部署架构不依赖物理备库，不过不具备地域级容灾能力。

## 两地两中心物理备库

用户希望达到地域级容灾，但是每个地域只有一个机房时，可以采用物理备库架构，选择一个地域作为主地域，部署主库，另一个地域部署备库。当备地域不可用时，不影响主地域的业务服务；当主地域不可用时，备库可以激活为新主库继续提供服务，这种情况下可能会丢失业务数据。

更进一步，用户可以利用两地两中心实现双活，部署两套物理备库，两个地域互为主备。这样可以更加高效利用资源，并且达到更高的容灾能力。

## 三地三中心仲裁服务



## 三地三中心五副本

为了支持地区级无损容灾，通过 Paxos 协议的原理可以证明，至少需要 3 个地区。OceanBase 数据库采用的是两地三中心的变种方案：三地三中心五副本。该方案包含三个城市，每个城市一个机房，前两个城市的机房各有两个副本，第三个城市的机房只有一个副本。和两地三中心的不同点在于，每次执行事务至少需要同步到两个城市，需要业务容忍异地复制的延时。

## 三地五中心仲裁服务

三个城市，五个机房，城市 1 和城市 2 距离较近，部署全功能副本，城市 3 部署仲裁服务以降低成本（无需同步日志）。任何一个机房故障故障（全功能副本所在机房故障），剩余全功能副本依然满足多数派（3/4），可以确保 RPO = 0。任意两个 IDC 或者城市级故障，如果故障的都是全功能副本所属机房，剩余两个全功能副本不足多数派（2/4），可通过仲裁降级方式恢复服务（将故障的两个副本降级为 Learner），并确保 RPO = 0。

由于 3 份以上副本才能构成多数派，但每个城市最多只有 2 份副本，为降低时延，城市 1 和城市 2 应该离得较近，以降低同步 Redo-Log 的时延。

## 三地五中心五副本

和三地三中心五副本类似，不同点在于，三地五中心会把每个副本部署到不同的机房，进一步强化机房容灾能力。
