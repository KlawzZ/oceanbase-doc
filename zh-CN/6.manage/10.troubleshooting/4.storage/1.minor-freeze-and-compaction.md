# 转储和合并

OceanBase 数据库的存储引擎基于 LSM-Tree 架构，数据大体上被分为 MemTable 和 SSTable 两部分，当 MemTable 的大小超过一定阈值时，就需要将 MemTable 中的数据转存到 SSTable 中以释放内存，将这一过程称之为转储；转储会生成新的 SSTable，当转储的次数超过一定阈值时，或者在每天的业务低峰期，会将基线 SSTable 与之后转储的增量  SSTable 合并为一个 SSTable，将这一过程称之为合并。


租户 MemTable 可使用的内存占总可用内存的比例为 `memstore_limit_percentage`，包括 Active MemTable 和 Frozen MemTable 两部分。当一个租户 MemTable 内存的使用量达到 `memstore_limit_percentage` * `freeze_trigger_percentage` 时，就会自动触发冻结（转储的前置动作），生成新的 Active MemTable，原来的 Active MemTable 成为 Frozen MemTable。然后再自动调度转储，转储完成后释放 Frozen MemTable 部分的内存。

<main id="notice" type='explain'>
    <h4>说明</h4>
    <ul>
    <li><code>memstore_limit_percentage</code> 用于设置租户使用 MemStore 的内存占其总可用内存的百分比，默认值是 50，取值范围是[1, 99]。有关该配置项的详细信息，参见 [memstore_limit_percentage](../../../7.reference/5.system-reference/1.system-configuration-items/3.cluster-level-configuration-items/139.memstore_limit_percentage.md)。</li>
    <li><code>freeze_trigger_percentage</code> 用于设置触发全局冻结的租户使用内存阈值，默认值是 20，取值范围是 (0, 100)。有关该配置项的详细信息，参见 [freeze_trigger_percentage](../../../7.reference/5.system-reference/1.system-configuration-items/4.tenant-level-configuration-items/54.freeze_trigger_percentage.md)。</li>
    </ul>
</main>

可以通过以下手段加快触发转储：

* 调低 `freeze_trigger_percentage`

* 手动执行 `alter system minor freeze` 触发

当一个租户的转储次数达到 `major_compact_trigger` 时自动触发合并。OceanBase 数据库 V4.0 默认为 0，表示关闭该方式的合并自动触发。

<main id="notice" type='explain'>
    <h4>说明</h4>
    <p><code>major_compact_trigger</code> 用于设置多少次转储并触发一次全局合并。取值范围为 [0, 65535]。有关该配置项的详细信息，参见 [major_compact_trigger](../../../7.reference/5.system-reference/1.system-configuration-items/4.tenant-level-configuration-items/18.major_compact_trigger.md)。</p>
</main>

可以通过以下手段加快触发合并：

* 调低 `major_compact_trigger`

* 手动执行 `alter system major freeze` 触发

## 合并切主失败

轮转合并过程中 Root Service 需要在两个 Primary Zone 之间切主，在合并某个 Primary Zone 之前，需要先把 Leader 切到另一个 Primary Zone （属于 Primary Region），如果另一个 Primary Zone 的副本无法当主（被 Stop Server、被 Stop Zone、缺副本、选举优先级不够），会导致 Root Service 打印如下日志：

```
$ grep 'cant switch leader for daily merge, please check it' rootservice.log
[2019-08-14 16:22:59.657326] ERROR [RS] set_zone_merging (ob_daily_merge_scheduler.cpp:654) [56663][YB420A34659E-00058BB3C222646D] [lt=12] cant switch leader for daily merge, please check it(zone=alipay.et15_1, fail_time=4) BACKTRACE:0x31471b9 0x30d51d7 0x8b5426 0x8a70ef 0x8ab817 0x8ad5e3 0x8adb70 0x8ae180 0x8aeaac 0x318f3cd 0x318d16e 0x7f65e6faddc5 0x7f65e58eaced
```

针对以上报错，排查流程如下：

1. 首先确认 Primary Region 中非 Leader 所在的其他 Zone 是否有如下情况。

    * 发生了 Stop Server：节点被 Stop 了，需要先拉起。

        <main id="notice" type='explain'>
        <h4>说明</h4>
        <p>关于重启节点的操作，参见 [重启节点](../../1.cluster-management/3.common-cluster-operations/3.restart-a-node.md)。</p>
        </main> 
    
    * 发生了 Stop Zone：另一个 Primary Zone 被 Stop 了，也会导致无法切主过去。
    
    * 目标 Zone 缺副本：查询内部视图确认是否缺副本，如是则需要先补副本。

        <main id="notice" type='explain'>
        <h4>说明</h4>
        <p>关于查看副本分布以及补副本的操作，参见 [查看 Locality](../../3.replica-management/2.replica-distribution/2.locality-common-operations/1.view-locality.md) 和 [增加副本](../../3.replica-management/2.replica-distribution/2.locality-common-operations/3.add-replica.md)。</p>
        </main> 

2. 如果上述情况都没有，需要确认是否是选主优先级不够。

    可以到 Root Service 所在机器，利用上述 Error 日志中的 Trace Id（`YB420A34659E-00058BB3C222646D`）检索完整的系统日志，以进一步分析。

    ```
    $ grep YB420A34659E-00058BB3C68E8756 log/rootservice.log
    ```

## 合并时数据不一致

数据不一致有三种情况：

* 行数不一致：主表与索引表的行数不一致。

* Column Checksum 不一致：Major SSTable 中有 column 的 checksum 值不一致。

* Data Checksum 不一致：Major SSTable 中所有行的 checksum 不一致。

