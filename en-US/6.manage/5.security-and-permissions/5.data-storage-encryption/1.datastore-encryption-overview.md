# Overview

Data storage encryption refers to transparent data encryption (TDE) of clog files and other data stored in disks. During TDE, data is automatically encrypted before the data is written to a storage device, and the data is automatically decrypted when it is read. The processes are transparent to users. Hackers and malicious users cannot read sensitive data from files, database backups, or disks. 

The user data and backups in OceanBase Database are stored as binary data on disks or other permanent storage media. Unauthorized users may obtain the media, and read and decode the stored data, which results in data leakage. The data stored in OceanBase Database is compressed. While compression provides a certain level of confidentiality, the data is still at risk of being decoded. To protect the security of data stored in memory and disks, OceanBase Database supports the AES and SM4 encryption algorithms. AES is a popular algorithm across the world, and SM4 is an algorithm developed by China. 

## Two-level key system

TDE encrypts and decrypts data in a two-level key system. The minimum encryption granularity is a database table. To encrypt a table, you must put it in an encrypted tablespace. OceanBase Database encrypts data in tablespaces. Tablespaces are designed to make OceanBase Database compatible with Oracle databases. You can consider a tablespace as a collection of tables. Each encrypted tablespace is configured with an encryption algorithm and a corresponding data key, which are used to encrypt the data in the tablespace. Each tenant has a master key to encrypt the data key for the tablespace. To prevent unauthorized decryption, the master key is stored in Keystore. 

<!-- ![Storage encryption](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1473623461/p358127.jpg) -->

To ensure data security, OceanBase Database does not allow users to use Keystore to view the master key or encryption key or to specify the master key or encryption key. The master key and encryption key are generated by the system and are not stored in plaintext on the disk. This greatly improves the security of the system. 

Keystore manages the master key and provides key management services. Features of Keystore:

* Generation of the master key: Keystore generates the master key based on the encryption algorithm. This provides a higher security level as users cannot specify the master key. 
* Storage of the information related to the master key: Keystore can obtain the master key based on relevant information. Keystore keeps multiple copies of information, ensures information consistency, and provides fault handling. 
* Master key management and multiversion concurrency control (MVCC): Keystore is used to modify the master key and supports MVCC. MVCC allows new master keys to be gradually applied. 
* Obtaining high availability services related to the master key. 
* Processing of Keystore commands. 

When you enable TDE, you must set the `tde_method` parameter to specify the storage method for the master key.

| Value of `tde_method` | Description |
|---------------|----|
| `none` | Disables storage encryption. |
| `internal` | Enables storage encryption and stores the master key in an internal table. |
| `bkmi` | Enables storage encryption and stores the master key in an external BKMI system. |

OceanBase Database supports only transparent tablespace encryption in internal mode. In internal mode, the encryption information of the master key is managed in internal tables, and clogs are not encrypted to avoid circular dependency during log replay. 

When encryption is enabled, the master key is used to encrypt data keys. The ciphertext of the data keys is stored in internal tables, macroblock headers, and clog headers. The data keys are not stored in plaintext. To encrypt and decrypt the data, use the master key to decrypt the ciphertext and obtain the data keys, and then decrypt the user data in the macroblocks or clogs. 

**Limits:**

* You cannot enable encryption for the sys tenant. 
* After you enable storage encryption for a tenant, the tenant cannot use other encryption methods. To use another encryption method, recreate a tenant. 

## Mechanism of valid encryption

User data stored on the disk includes clogs and macroblock data, and data is encrypted only when it is written to the disk. In-memory data is not encrypted. If you enable encryption for a table that is not encrypted, its existing unencrypted clogs and macroblock data on the disk are not encrypted. Only the subsequent data written to the disk is encrypted. Each clog and each macroblock records encrypted metadata. Therefore, encrypted and unencrypted data can be coexistent. 

Clogs are appended to existing ones on the disk. Unencrypted existing clogs remain unencrypted. After you have enabled encryption for a period when the existing unencrypted clogs are recycled, the clog data on the disk are all encrypted. Macroblock data is written to the disk only in minor compactions or major compactions. You can manually trigger a full major compaction to encrypt all macroblocks that are not encrypted. 

## Supported encryption algorithms

OceanBase Database supports major international encryption algorithms such as AES and Chinese standard algorithms such as SM4.

| Algorithm | Key length | Mode |
|-----|------------------------------------------------------------|-----|
| AES | 128 bits, 192 bits, and 256 bits | Electronic codebook (ECB) |
| SM4 | 128 bits | Cipher block chaining (CBC) |